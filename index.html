<!DOCTYPE html>
<html>
<head> 
    <title>Smart Desk Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <h1>Smart Desk Monitor</h1>
    {% if not current_user.is_authenticated %}
        <div class="welcome">Not authenticated. <a href="{{ url_for('login') }}">Login</a></div>
    {% else %}
        <p class="welcome">Welcome, {{ current_user.username }}! <a href="{{ url_for('logout') }}" class="logout">Logout</a></p>
    {% endif %}
    <h2>Total Work Hours: {{ "%.2f" % total_hours }}</h2>
    <h3>Current Session: <span id="timer" class="not-working">Not Working</span></h3>
    <!-- Sensor controls sessions automatically; manual start/stop removed -->
    <h3>Work Sessions</h3>
    <table class="table table-striped table-bordered table-dark table-hover">
        <tr><th>Start Time</th><th>End Time</th><th>Duration (Hours)</th><th>Actions</th></tr>
        {% for sid, start, end in sessions %}
        <tr>
            <td>{{ start.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>{{ end.strftime('%Y-%m-%d %H:%M:%S') if end else 'Ongoing' }}</td>
            <td>{{ "%.2f" % ((end - start).total_seconds() / 3600) if end else '-' }}</td>
            <td>
                <form method="POST" action="{{ url_for('delete_session') }}" style="display:inline;">
                    <input type="hidden" name="session_id" value="{{ sid }}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this session?');">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- Productivity chart + table -->
    <h3>Daily Productivity (Last 7 Days)</h3>
    <canvas id="productivityChart" width="600" height="200"></canvas>

    <table id="productivityTable" class="table table-sm table-bordered" style="max-width:400px;">
        <thead><tr><th>Day</th><th>Hours</th></tr></thead>
        <tbody>
            <!-- populated by JS -->
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${hrs}:${mins}:${secs}`;
        }

        function updateTimer() {
            fetch('/timer')
                .then(response => response.json())
                .then(data => {
                    const timerElement = document.getElementById('timer');
                    if (data.status === 'working') {
                        timerElement.textContent = formatTime(data.elapsed);
                        timerElement.className = 'working';
                    } else {
                        timerElement.textContent = 'Not Working';
                        timerElement.className = 'not-working';
                    }
                })
                .catch(error => {
                    console.error('Timer error:', error);
                    document.getElementById('timer').textContent = 'Error';
                });
        }

        // Load productivity chart + table
        fetch('/daily_hours')
            .then(response => response.json())
            .then(data => {
                // render chart
                const ctx = document.getElementById('productivityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Work Hours',
                            data: data.hours,
                            backgroundColor: '#4CAF50'
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } },
                        plugins: { title: { display: true, text: 'Daily Work Hours (Last 7 Days)' } }
                    }
                });

                // populate table
                const tbody = document.querySelector('#productivityTable tbody');
                tbody.innerHTML = '';
                data.details.forEach(row => {
                    const tr = document.createElement('tr');
                    const tdDate = document.createElement('td');
                    tdDate.textContent = row.date;
                    const tdHours = document.createElement('td');
                    tdHours.textContent = row.hours.toFixed(2);
                    tr.appendChild(tdDate);
                    tr.appendChild(tdHours);
                    tbody.appendChild(tr);
                });
            })
            .catch(error => console.error('Chart error:', error));

        updateTimer();
        setInterval(updateTimer, 1000);
    </script>
</body>
</html>